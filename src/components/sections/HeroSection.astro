---
---
<section class="relative flex min-h-screen items-center overflow-hidden">
  <div class="absolute inset-0 overflow-hidden">
    <img id="hero-video-poster" src="/Website2026/images/hero-mobile.svg" alt="Night power grid and electricians" class="h-full w-full object-cover" />
    <video
      id="hero-video-local"
      class="absolute left-1/2 top-1/2 hidden h-[56.25vw] min-h-full w-[177.78vh] min-w-full -translate-x-1/2 -translate-y-1/2 object-cover brightness-140 contrast-112 saturate-120 blur-[1px]"
      autoplay
      muted
      loop
      playsinline
      preload="auto"
      poster="/Website2026/images/hero-mobile.svg"
    >
      <source src="/Website2026/videos/hero-4k.webm" type="video/webm" />
      <source src="/Website2026/videos/hero-4k.mp4" type="video/mp4" />
    </video>
    <iframe
      id="hero-video-iframe"
      class="absolute left-1/2 top-1/2 hidden h-[56.25vw] min-h-full w-[177.78vh] min-w-full -translate-x-1/2 -translate-y-1/2 brightness-140 contrast-112 saturate-120 blur-[1px]"
      data-video-id="jkLZ5O1REY4"
      title="Electrical infrastructure background"
      loading="eager"
      allow="autoplay; encrypted-media; fullscreen; picture-in-picture"
      referrerpolicy="strict-origin-when-cross-origin"
    ></iframe>
  </div>
  <div class="hero-overlay absolute inset-0"></div>
  <div class="hero-edge-vignette absolute inset-0"></div>

  <div class="container-shell relative z-20 py-20">
    <h1 class="section-title max-w-4xl font-black">إصلاح الكهرباء</h1>
    <p class="mt-4 text-lg text-white/88">Wired for Excellence.</p>
    <button id="hero-video-play-mobile" type="button" class="mt-6 inline-flex min-h-12 items-center rounded-md border border-white/30 bg-black/45 px-4 text-sm font-semibold text-white md:hidden">
      Tap to play background video
    </button>
  </div>

  <script is:inline>
    const randomStartPoint = (duration) => {
      if (!Number.isFinite(duration) || duration <= 1) return 0;
      const safeStartMin = duration * 0.22;
      const safeStartMax = duration * 0.72;
      return Math.floor(safeStartMin + Math.random() * Math.max(1, safeStartMax - safeStartMin));
    };

    const toggleVisualLayers = (mode) => {
      const poster = document.getElementById('hero-video-poster');
      const localVideo = document.getElementById('hero-video-local');
      const iframe = document.getElementById('hero-video-iframe');

      if (!(poster instanceof HTMLImageElement) || !(localVideo instanceof HTMLVideoElement) || !(iframe instanceof HTMLIFrameElement)) return;

      if (mode === 'local') {
        poster.classList.add('hidden');
        localVideo.classList.remove('hidden');
        iframe.classList.add('hidden');
      }

      if (mode === 'youtube') {
        poster.classList.add('hidden');
        localVideo.classList.add('hidden');
        iframe.classList.remove('hidden');
      }

      if (mode === 'poster') {
        poster.classList.remove('hidden');
        localVideo.classList.add('hidden');
        iframe.classList.add('hidden');
      }
    };

    const buildVideoUrl = (videoId, startSeconds) => {
      const params = new URLSearchParams({
        autoplay: '1',
        mute: '1',
        loop: '1',
        playlist: videoId,
        controls: '0',
        modestbranding: '1',
        playsinline: '1',
        rel: '0',
        iv_load_policy: '3',
        start: String(startSeconds),
        vq: 'hd2160',
        enablejsapi: '1',
        origin: window.location.origin,
      });

      return `https://www.youtube-nocookie.com/embed/${videoId}?${params.toString()}`;
    };

    const postPlayerCommand = (iframe, func, args = []) => {
      iframe.contentWindow?.postMessage(
        JSON.stringify({ event: 'command', func, args }),
        '*',
      );
    };

    const requestBestQuality = (iframe) => {
      postPlayerCommand(iframe, 'setPlaybackQualityRange', ['highres']);
      postPlayerCommand(iframe, 'setPlaybackQuality', ['highres']);
      postPlayerCommand(iframe, 'setPlaybackQualityRange', ['hd2160']);
      postPlayerCommand(iframe, 'setPlaybackQuality', ['hd2160']);
      postPlayerCommand(iframe, 'setPlaybackQualityRange', ['hd1440']);
      postPlayerCommand(iframe, 'setPlaybackQuality', ['hd1440']);
    };

    const attemptAutoplay = (iframe) => {
      postPlayerCommand(iframe, 'mute');
      requestBestQuality(iframe);
      postPlayerCommand(iframe, 'playVideo');
    };

    const setVideoSource = (startSeconds) => {
      const iframe = document.getElementById('hero-video-iframe');
      if (!(iframe instanceof HTMLIFrameElement)) return;

      const videoId = iframe.dataset.videoId;
      if (!videoId) return;

      iframe.src = buildVideoUrl(videoId, startSeconds);
    };

    const startYoutubeFallback = () => {
      const iframe = document.getElementById('hero-video-iframe');
      if (!(iframe instanceof HTMLIFrameElement)) return;

      const randomStart = Math.floor(45 + Math.random() * 210);
      toggleVisualLayers('youtube');
      setVideoSource(randomStart);

      iframe.onload = () => {
        let tries = 0;
        const timer = window.setInterval(() => {
          attemptAutoplay(iframe);
          tries += 1;
          if (tries >= 8) window.clearInterval(timer);
        }, 400);
      };
    };

    const wireMobileTapFallback = () => {
      const button = document.getElementById('hero-video-play-mobile');
      if (!(button instanceof HTMLButtonElement)) return;

      const localVideo = document.getElementById('hero-video-local');
      const isMobile = window.matchMedia('(max-width: 767px)').matches;

      if (!isMobile) {
        button.classList.add('hidden');
        return;
      }

      const hideButton = () => button.classList.add('hidden');

      button.classList.remove('hidden');
      button.onclick = () => {
        if (localVideo instanceof HTMLVideoElement) {
          toggleVisualLayers('local');
          const playPromise = localVideo.play();
          if (playPromise && typeof playPromise.catch === 'function') {
            playPromise
              .then(() => hideButton())
              .catch(() => {
                startYoutubeFallback();
                hideButton();
              });
          } else {
            hideButton();
          }
          return;
        }

        startYoutubeFallback();
        hideButton();
      };
    };

    const startLocalVideo = () => {
      const localVideo = document.getElementById('hero-video-local');
      if (!(localVideo instanceof HTMLVideoElement)) {
        startYoutubeFallback();
        return;
      }

      toggleVisualLayers('poster');

      let settled = false;
      const fallbackTimer = window.setTimeout(() => {
        if (settled) return;
        settled = true;
        startYoutubeFallback();
      }, 1800);

      const onMetadata = () => {
        if (settled) return;
        settled = true;
        window.clearTimeout(fallbackTimer);

        localVideo.currentTime = randomStartPoint(localVideo.duration);
        toggleVisualLayers('local');
        const playPromise = localVideo.play();
        if (playPromise && typeof playPromise.catch === 'function') {
          playPromise.catch(() => startYoutubeFallback());
        }
      };

      localVideo.addEventListener('loadedmetadata', onMetadata, { once: true });
      localVideo.addEventListener('error', () => {
        if (settled) return;
        settled = true;
        window.clearTimeout(fallbackTimer);
        startYoutubeFallback();
      }, { once: true });
      localVideo.load();
    };

    const hydrateHeroVideo = () => {
      wireMobileTapFallback();
      startLocalVideo();
    };

    hydrateHeroVideo();
    document.addEventListener('astro:page-load', hydrateHeroVideo);
  </script>
</section>
